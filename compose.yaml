name: vrf

services:
  drand1:
    image: ${SIDECAR_IMAGE:-vrf-sidecar:dev}
    entrypoint: ["sh", "-lc"]
    command:
      - exec sh /scripts/drand/start.sh
    environment:
      DRAND_ROLE: leader
      DRAND_BINARY: /bin/drand
      DRAND_ID: ${DRAND_ID:-default}
      DRAND_SCHEME: ${DRAND_SCHEME:-pedersen-bls-chained}
      DRAND_DATA_DIR: ${DRAND_DATA_DIR_NODE1:-/var/lib/vrf/drand/node1}
      DRAND_PRIVATE_ADDR: ${DRAND_PRIVATE_ADDR_NODE1:-0.0.0.0:4444}
      DRAND_PUBLIC_ADDR: ${DRAND_PUBLIC_ADDR_NODE1:-0.0.0.0:8081}
      DRAND_CONTROL_PORT: ${DRAND_CONTROL_PORT_NODE1:-8881}
      DRAND_KEYPAIR_ADDR: ${DRAND_KEYPAIR_ADDR_NODE1:-drand1:4444}
      DRAND_JOINER_ADDR: ${DRAND_KEYPAIR_ADDR_NODE2:-drand2:4444}
      DRAND_DKG_THRESHOLD: ${DRAND_DKG_THRESHOLD:-2}
      DRAND_DKG_PERIOD_SECONDS: ${DRAND_DKG_PERIOD_SECONDS:-3}
      DRAND_DKG_GENESIS_DELAY_SECONDS: ${DRAND_DKG_GENESIS_DELAY_SECONDS:-5}
      VRF_RUNTIME_DIR: ${VRF_RUNTIME_DIR:-/var/run/vrf}
      VRF_DRAND_INFO_FILE: ${VRF_DRAND_INFO_FILE:-/var/run/vrf/drand-info.json}
    volumes:
      - ./scripts:/scripts:ro
      - drand-data:/var/lib/vrf/drand
      - vrf-socket:/var/run/vrf
    restart: unless-stopped

  drand2:
    image: ${SIDECAR_IMAGE:-vrf-sidecar:dev}
    entrypoint: ["sh", "-lc"]
    command:
      - exec sh /scripts/drand/start.sh
    environment:
      DRAND_ROLE: joiner
      DRAND_BINARY: /bin/drand
      DRAND_ID: ${DRAND_ID:-default}
      DRAND_SCHEME: ${DRAND_SCHEME:-pedersen-bls-chained}
      DRAND_DATA_DIR: ${DRAND_DATA_DIR_NODE2:-/var/lib/vrf/drand/node2}
      DRAND_PRIVATE_ADDR: ${DRAND_PRIVATE_ADDR_NODE2:-0.0.0.0:4444}
      DRAND_PUBLIC_ADDR: ${DRAND_PUBLIC_ADDR_NODE2:-0.0.0.0:8081}
      DRAND_CONTROL_PORT: ${DRAND_CONTROL_PORT_NODE2:-8881}
      DRAND_KEYPAIR_ADDR: ${DRAND_KEYPAIR_ADDR_NODE2:-drand2:4444}
    volumes:
      - ./scripts:/scripts:ro
      - drand-data:/var/lib/vrf/drand
    restart: unless-stopped

  chain:
    depends_on:
      - drand1
      - drand2
    image: ${CHAIN_IMAGE:-vrf-chain:dev}
    build:
      context: .
      dockerfile: contrib/images/chain.Dockerfile
      args:
        GO_VERSION: ${DOCKER_GO_VERSION:-1.25.3}
        ALPINE_VERSION: ${DOCKER_ALPINE_VERSION:-3.22}
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-}
        BUILD_TAGS: ${DOCKER_BUILD_TAGS:-muslc}
        LEDGER_ENABLED: ${DOCKER_LEDGER_ENABLED:-false}
        LINK_STATICALLY: ${DOCKER_LINK_STATICALLY:-true}
        SKIP_TIDY: ${DOCKER_SKIP_TIDY:-true}
    entrypoint: ["sh", "-lc"]
    command:
      - |
        sh /scripts/chain/init.sh
        exec sh /scripts/chain/start.sh
    environment:
      MONIKER: ${MONIKER:-node001}
      CHAIN_ID: ${CHAIN_ID:-chain-1}
      DENOM: ${DENOM:-uchain}
      KEYNAME: ${KEYNAME:-validator}
      KEYRING_BACKEND: ${KEYRING_BACKEND:-test}
      CHAIN_DIR: ${CHAIN_DIR:-/.vrf/.chaind}
      VRF_RUNTIME_DIR: ${VRF_RUNTIME_DIR:-/var/run/vrf}
      VRF_DRAND_INFO_FILE: ${VRF_DRAND_INFO_FILE:-/var/run/vrf/drand-info.json}
      RESET_CHAIN: ${RESET_CHAIN:-false}
      TIMEOUT_COMMIT: ${TIMEOUT_COMMIT:-2s}
      BLOCK_GAS_LIMIT: ${BLOCK_GAS_LIMIT:-10000000}
      MIN_GAS_PRICES: ${MIN_GAS_PRICES:-0uchain}
      TRACE: ${TRACE:-false}
    ports:
      - "${CHAIN_P2P_PORT:-26656}:26656"
      - "${CHAIN_RPC_PORT:-26657}:26657"
      - "${CHAIN_API_PORT:-1317}:1317"
      - "${CHAIN_GRPC_PORT:-9090}:9090"
    volumes:
      - ./scripts:/scripts:ro
      - chain-data:/.vrf/.chaind
      - vrf-socket:/var/run/vrf
    restart: unless-stopped

  sidecar:
    depends_on:
      - drand1
      - drand2
    image: ${SIDECAR_IMAGE:-vrf-sidecar:dev}
    build:
      context: .
      dockerfile: contrib/images/sidecar.Dockerfile
      args:
        GO_VERSION: ${DOCKER_GO_VERSION:-1.25.3}
        ALPINE_VERSION: ${DOCKER_ALPINE_VERSION:-3.22}
        VERSION: ${VERSION:-dev}
        COMMIT: ${COMMIT:-}
        BUILD_TAGS: ${DOCKER_BUILD_TAGS:-muslc}
        DRAND_CONN_INSECURE: ${DRAND_CONN_INSECURE:-true}
        LEDGER_ENABLED: ${DOCKER_LEDGER_ENABLED:-false}
        LINK_STATICALLY: ${DOCKER_LINK_STATICALLY:-true}
        SKIP_TIDY: ${DOCKER_SKIP_TIDY:-true}
    entrypoint: ["sh", "-lc"]
    command:
      - exec sh /scripts/sidecar/start.sh
    environment:
      VRF_RUNTIME_DIR: ${VRF_RUNTIME_DIR:-/var/run/vrf}
      VRF_DRAND_INFO_FILE: ${VRF_DRAND_INFO_FILE:-/var/run/vrf/drand-info.json}

      SIDECAR_LISTEN_ADDR: ${SIDECAR_LISTEN_ADDR:-unix:///var/run/vrf/sidecar.sock}
      VRF_ALLOW_PUBLIC_BIND: ${VRF_ALLOW_PUBLIC_BIND:-false}

      METRICS_ENABLED: ${METRICS_ENABLED:-false}
      METRICS_ADDR: ${METRICS_ADDR:-127.0.0.1:8091}
      METRICS_CHAIN_ID: ${METRICS_CHAIN_ID:-}

      # Used by scripts/sidecar/start.sh auto-wiring (loads x/vrf params from genesis).
      CHAIN_DIR: ${CHAIN_DIR:-/.vrf/.chaind}

      DRAND_SUPERVISE: ${DRAND_SUPERVISE:-false}
      DRAND_ALLOW_NON_LOOPBACK_HTTP: ${DRAND_ALLOW_NON_LOOPBACK_HTTP:-true}
      DRAND_BOOTSTRAP: ${DRAND_BOOTSTRAP:-false}
      DRAND_HTTP: ${DRAND_HTTP:-http://drand1:8081}
      DRAND_BINARY: ${DRAND_BINARY:-/bin/drand}
      DRAND_DATA_DIR: ${DRAND_DATA_DIR:-/var/lib/vrf/drand}
      DRAND_PUBLIC_ADDR: ${DRAND_PUBLIC_ADDR:-127.0.0.1:8081}
      DRAND_PRIVATE_ADDR: ${DRAND_PRIVATE_ADDR:-0.0.0.0:4444}
      DRAND_CONTROL_ADDR: ${DRAND_CONTROL_ADDR:-127.0.0.1:8881}
      DRAND_ID: ${DRAND_ID:-default}

      DRAND_CHAIN_HASH: ${DRAND_CHAIN_HASH:-}
      DRAND_PUBLIC_KEY: ${DRAND_PUBLIC_KEY:-}
      DRAND_PERIOD_SECONDS: ${DRAND_PERIOD_SECONDS:-}
      DRAND_GENESIS_UNIX: ${DRAND_GENESIS_UNIX:-}
    volumes:
      - ./scripts:/scripts:ro
      - chain-data:/.vrf/.chaind:ro
      - vrf-socket:/var/run/vrf
    restart: unless-stopped

volumes:
  chain-data:
  drand-data:
  vrf-socket:
